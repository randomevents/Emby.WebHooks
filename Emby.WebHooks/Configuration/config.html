<!DOCTYPE html>
<html>
<head>
    <title>WebHooks</title>
</head>
<body>
    <div data-role="page" class="page type-interior pluginConfigurationPage WebHooksPage" data-require="emby-select,emby-checkbox,emby-input,emby-button,emby-textarea">
        <div id="itemTemplate" style="display:none;">
            <div class="singleHook">
                <div>
                    <div>
                        <div class="inputContainer" style="display: inline-flex; margin-bottom: 1em;">
                            <input is="emby-input" type="text" class="txtTitle"/>
                            <button is="emby-button" data-action="expandCollapse" type="button" class="button-submit emby-button">Expand</button>
                            <button title="Delete" class="btnDeleteDevice paper-icon-button-light removeHook listItemButton" type="button" is="paper-icon-button-light"><i class="md-icon">delete</i></button>
                        </div>
                    </div>
                    <div class="content" style="display:none;">
                        <div>
                            <div class="inputContainer">
                                <input is="emby-input" type="text" class="txtUrl" label="URL:Port"/>
                            </div>
                        </div>
                        <div>
                            <h3 class="checkboxListLabel">Media Types</h3>
                            <div class="paperList checkboxList-paperList">
                            <label>
                                <input is="emby-checkbox" type="checkbox" class="chkMovies" />
                                <span>Movies</span>
                            </label>
                            <label>
                                <input is="emby-checkbox" type="checkbox" class="chkEpisodes" />
                                <span>TV Shows</span>
                            </label>
                            <label>
                                <input is="emby-checkbox" type="checkbox" class="chkSongs" />
                                <span>Music</span>
                            </label>
                            </div>
                        </div>
                        <div>
                            <h3 class="checkboxListLabel">Playback Events</h3>
                            <div class="paperList checkboxList-paperList">
                                <label>
                                    <input is="emby-checkbox" type="checkbox" class="chkOnPlay" />
                                    <span>Play</span>
                                </label>
                                <label>
                                    <input is="emby-checkbox" type="checkbox" class="chkOnPause" />
                                    <span>Pause</span>
                                </label>
                                <label>
                                    <input is="emby-checkbox" type="checkbox" class="chkOnStop" />
                                    <span>Stop</span>
                                </label>
                                <label>
                                    <input is="emby-checkbox" type="checkbox" class="chkOnResume" />
                                    <span>Resume</span>
                                </label>
                            </div>
                            <div class="inputContainer">
                                <h3 class="inputLabel inputLabelUnfocused">Playback Payload</h3>
                                <textarea is="emby-textarea" type="text" class="emby-textarea txtPlayback" rows="7" label="Message"></textarea>
                            </div>
                            <div class="fieldDescription">
                                Available Keywords:
                                <ul style="columns: 3;">
                                    <li>{{Event}} (string)</li>
                                    <li>{{ServerID}} (string)</li>
                                    <li>{{ServerName}} (string)</li>
                                    <li>{{UserID}} (string)</li>
                                    <li>{{UserName}} (string)</li>
                                    <li>{{DeviceID}} (string)</li>
                                    <li>{{DeviceName}} (string)</li>
                                    <li>{{ItemType}} (string)</li>
                                    <li>{{ItemName}} (string)</li>
                                    <li>{{ItemNameParent}} (string)</li>
                                    <li>{{ItemNameGrandparent}} (string)</li>
                                    <li>{{ItemID}} (string)</li>
                                    <li>{{ItemRunTimeTicks}} (int)</li>
                                    <li>{{ItemIndex}} (int)</li>
                                    <li>{{ItemParentIndex}} (int)</li>
                                    <li>{{ItemDateAdded}} (string)</li>
                                    <li>{{ItemYear}} (int)</li>
                                    <li>{{ItemGenre}} (string)</li>
                                    <li>{{SessionID}} (string)</li>
                                    <li>{{SessionPlaybackPositionTicks}} (double)</li>
                                    <li>{{TimeStamp}} (string/yyyy-MM-dd HH:mm:ss.fff)</li>
                                </ul>
                            </div>
                            <h3 class="checkboxListLabel">Server Events</h3>
                            <div class="paperList checkboxList-paperList">
                                <label>
                                    <input is="emby-checkbox" type="checkbox" class="chkOnItemAdded" />
                                    <span>Item Added</span>
                                </label>
                            </div>
                            <div class="inputContainer">
                                <h3 class="inputLabel inputLabelUnfocused">Server Payload</h3>
                                <textarea is="emby-textarea" type="text" class="emby-textarea txtServer" rows="7" label="Message"></textarea>
                            </div>
                            <div class="fieldDescription">
                                Available Keywords:
                                <ul style="columns: 3;">
                                    <li>{{Event}} (string)</li>
                                    <li>{{ServerID}} (string)</li>
                                    <li>{{ServerName}} (string)</li>
                                    <li>{{ItemType}}  (string)</li>
                                    <li>{{ItemName}}  (string)</li>
                                    <li>{{ItemNameParent}}  (string)</li>
                                    <li>{{ItemNameGrandparent}}  (string)</li>
                                    <li>{{ItemID}}  (string)</li>
                                    <li>{{ItemRunTimeTicks}}  (int)</li>
                                    <li>{{ItemIndex}}  (int)</li>
                                    <li>{{ItemParentIndex}}  (int)</li>
                                    <li>{{ItemDateAdded}}  (string)</li>
                                    <li>{{ItemYear}}  (int)</li>
                                    <li>{{ItemGenre}}  (string)</li>
                                    <li>{{TimeStamp}} (string/yyyy-MM-dd HH:mm:ss.fff)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <hr>
        </div>

        <div data-role="content">
            <div class="content-primary">

                <form class="WebHooksForm">
                    <h1 style="display:inline-block;vertical-align:middle;">WebHooks</h1>
                    <button title="Add" class="raised btnAddDevice submit mini emby-button" id="addHook"
                            style="margin-left:1em;" type="button" is="emby-button">
                        <i class="md-icon">add</i>
                        <span>Add</span>
                    </button>
                    <div id="Hooks">
                    </div>
                    <br />
                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block"><span>Save</span></button>
                    </div>

                </form>
            </div>
        </div>

        <script type="text/javascript">

            (function () {

                var pluginId = "426eb1da-a1de-4ae2-bb79-cb7acb302997";
                function loadUserConfig(page, userId) {

                    Dashboard.showLoadingMsg();

                    ApiClient.getPluginConfiguration(pluginId).then(function (config) {

                        Dashboard.hideLoadingMsg();
                    });
                }

                $('.WebHooksPage').on('pageinit', function (event) {

                    var page = this;
                    $(page).on("click", ".removeHook", function removeHook() {
                        $(this).parent().parent().remove();
                    });

                    $(page).on("click", '[data-action="expandCollapse"]', function toggleContent() {
                        var $this = $(this);
                        if ($this.text() === 'Expand')
                            $this.text('Collapse');
                        else
                            $this.text('Expand');

                        $this.closest('.singleHook').find('.content').toggle(800);
                    });
                    

                    $('#addHook', page).on('click', function (event) {

                        Dashboard.showLoadingMsg();
                        var a = $('#itemTemplate').clone();
                        $('#Hooks', page).append(a);
                        $(a).show();

                        Dashboard.hideLoadingMsg();


                    });

                    $('.WebHooksForm', page).on('submit', function (e) {

                        Dashboard.showLoadingMsg();
                        var form = this;

                        var config = { Hooks: [] };
                        $('#Hooks .singleHook', form).each(function (i) {
                            config.Hooks.push(
                                {
                                    Name: $(this).find('.txtTitle').first().val(),
                                    URL: $(this).find('.txtUrl').first().val(),
                                    onPlay: $(this).find('.chkOnPlay').first().checked(),
                                    onPause: $(this).find('.chkOnPause').first().checked(),
                                    onStop: $(this).find('.chkOnStop').first().checked(),
                                    onResume: $(this).find('.chkOnResume').first().checked(),

                                    withMovies: $(this).find('.chkMovies').first().checked(),
                                    withEpisodes: $(this).find('.chkEpisodes').first().checked(),
                                    withSongs: $(this).find('.chkSongs').first().checked(),
                                    onItemAdded: $(this).find('.chkOnItemAdded').first().checked(),

                                    msgPlaybackEventHook: $(this).find('.txtPlayback').first().val(),
                                    msgServerEventHook: $(this).find('.txtPlayback').first().val(),
                                }
                            );
                        });

                        console.log(config);

                        ApiClient.updatePluginConfiguration(pluginId, config).then(
                            Dashboard.processPluginConfigurationUpdateResult);
                        return false;
                    });

                }).on('pageshow', function (event) {

                    Dashboard.showLoadingMsg();

                    var page = this;

                    ApiClient.getPluginConfiguration(pluginId).then(function (config) {
                        for (var i in config.Hooks) {
                            var a = $('#itemTemplate').clone();

                            $(a).show();
                            $('#Hooks', page).append(a);
                            $(a).find('.txtTitle').first().val(config.Hooks[i].Name || 'My Webhook');
                            $(a).find('.txtUrl').first().val(config.Hooks[i].URL || '');

                            $(a).find('.chkOnPlay').first().checked(config.Hooks[i].onPlay || false);
                            $(a).find('.chkOnPause').first().checked(config.Hooks[i].onPause || false);
                            $(a).find('.chkOnStop').first().checked(config.Hooks[i].onStop || false);
                            $(a).find('.chkOnResume').first().checked(config.Hooks[i].onResume || false);

                            $(a).find('.chkMovies').first().checked(config.Hooks[i].withMovies || false);
                            $(a).find('.chkEpisodes').first().checked(config.Hooks[i].withEpisodes || false);
                            $(a).find('.chkSongs').first().checked(config.Hooks[i].withSongs || false);
                            $(a).find('.chkOnItemAdded').first().checked(config.Hooks[i].onItemAdded || false);

                            $(a).find('.txtPlayback').first().val(config.Hooks[i].msgPlaybackEventHook || '{\n' +
                                '    "event": "{{Event}}",\n' +
                                '    "serverId": "{{ServerID}}",\n' +
                                '    "serverName": "{{ServerName}}",\n' +
                                '    "userID": "{{UserID}}",\n' +
                                '    "userName": "{{UserName}}",\n' +
                                '    "deviceID": "{{DeviceID}}",\n' +
                                '    "itemType": "{{ItemType}}",\n' +
                                '    "itemName": "{{ItemName}}",\n' +
                                '    "itemNameParent": "{{ItemNameParent}}",\n' +
                                '    "itemNameGrandparent": "{{ItemNameGrandparent}}",\n' +
                                '    "itemID": "{{ItemID}}",\n' +
                                '    "itemRunTimeTicks": {{ItemRunTimeTicks}},\n' +
                                '    "itemIndex": {{ItemIndex}},\n' +
                                '    "itemParentIndex": {{ItemParentIndex}},\n' +
                                '    "itemDateAdded": "{{ItemDateAdded}}",\n' +
                                '    "itemYear": {{ItemYear}},\n' +
                                '    "itemGenre": "{{ItemGenre}}",\n' +
                                '    "sessionID": "{{SessionID}}",\n' +
                                '    "sessionPlaybackPositionTicks": {{SessionPlaybackPositionTicks}},\n' +
                                '    "timeStamp": "{{TimeStamp}}"\n' +
                                '}');
                            
                            $(a).find('.txtServer').first().val(config.Hooks[i].msgServerEventHook || '{\n' +
                                '    "event": "{{Event}}",\n' +
                                '    "serverId": "{{ServerID}}",\n' +
                                '    "serverName": "{{ServerName}}",\n' +
                                '    "itemType": "{{ItemType}}",\n' +
                                '    "itemName": "{{ItemName}}",\n' +
                                '    "itemNameParent": "{{ItemNameParent}}",\n' +
                                '    "itemNameGrandparent": "{{ItemNameGrandparent}}",\n' +
                                '    "itemID": "{{ItemID}}",\n' +
                                '    "itemRunTimeTicks": {{ItemRunTimeTicks}},\n' +
                                '    "itemIndex": {{ItemIndex}},\n' +
                                '    "itemParentIndex": {{ItemParentIndex}},\n' +
                                '    "itemDateAdded": "{{ItemDateAdded}}",\n' +
                                '    "itemYear": {{ItemYear}},\n' +
                                '    "itemGenre": "{{ItemGenre}}",\n' +
                                '    "timeStamp": "{{TimeStamp}}"\n' +
                                '}');
                        }
                    });

                    Dashboard.hideLoadingMsg();
                });
            })();
        </script>
    </div>
</body>
</html>
